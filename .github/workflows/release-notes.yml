name: Release Notes

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag name to update (e.g. v0.1.6)'
        required: true

permissions:
  contents: write

jobs:
  update-release-notes:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set Tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "name=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "name=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Get Previous Tag
        id: prev_tag
        run: |
          CURRENT_TAG="${{ steps.tag.outputs.name }}"
          PREV_TAG=$(git tag --sort=-version:refname | grep -A1 "^${CURRENT_TAG}$" | tail -1)
          if [ "$PREV_TAG" = "$CURRENT_TAG" ] || [ -z "$PREV_TAG" ]; then
            PREV_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "Current: $CURRENT_TAG, Previous: $PREV_TAG"

      - name: Get Commits
        id: commits
        run: |
          COMMITS=$(git log ${{ steps.prev_tag.outputs.prev_tag }}..${{ steps.tag.outputs.name }} --pretty=format:"- %s (%h)" --no-merges | head -50)
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate Release Notes
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          settings: |
            {
              "env": {
                "ANTHROPIC_BASE_URL": "${{ secrets.ANTHROPIC_BASE_URL }}",
                "ANTHROPIC_AUTH_TOKEN": "${{ secrets.ANTHROPIC_AUTH_TOKEN }}",
                "CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC": "1"
              }
            }
          prompt: |
            è¯·ä¸º GitHub Release ç”Ÿæˆä¸­æ–‡å‘å¸ƒè¯´æ˜ã€‚

            **ç‰ˆæœ¬**: ${{ steps.tag.outputs.name }}
            **ä»“åº“**: ${{ github.repository }}

            **æœ¬æ¬¡å‘å¸ƒåŒ…å«çš„ Commits**:
            ```
            ${{ steps.commits.outputs.commits }}
            ```

            **è¦æ±‚**:
            1. ä½¿ç”¨ä¸­æ–‡æ’°å†™
            2. æŒ‰ç…§ä»¥ä¸‹åˆ†ç±»æ•´ç† commits:
               - âœ¨ Features (feat): æ–°åŠŸèƒ½
               - ğŸ› Bug Fixes (fix): ä¿®å¤
               - ğŸ”§ Improvements (refactor/perf/style): ä¼˜åŒ–æ”¹è¿›
               - ğŸ”¨ CI/CD (ci/build): æ„å»ºéƒ¨ç½²
               - ğŸ“ Documentation (docs): æ–‡æ¡£
               - ğŸ§¹ Chores (chore): å…¶ä»–
            3. åªä¿ç•™æœ‰å®é™…å†…å®¹çš„åˆ†ç±»ï¼Œç©ºåˆ†ç±»ä¸æ˜¾ç¤º
            4. æ¯æ¡è®°å½•ç®€æ´æ˜äº†ï¼Œçªå‡ºå˜æ›´è¦ç‚¹
            5. æœ«å°¾æ·»åŠ  Full Changelog é“¾æ¥

            **è¾“å‡ºæ ¼å¼** (ç‰ˆæœ¬å·ç”¨å®é™…çš„ ${{ steps.tag.outputs.name }} æ›¿æ¢ï¼Œå»æ‰ v å‰ç¼€ä½œä¸ºæ–‡ä»¶ç‰ˆæœ¬å·):
            ```markdown
            ## What's Changed

            ### âœ¨ Features
            - **åŠŸèƒ½åç§°**: ç®€çŸ­æè¿°

            ### ğŸ› Bug Fixes
            - **ä¿®å¤å†…å®¹**: ç®€çŸ­æè¿°

            ---

            ## ğŸ“¦ ä¸‹è½½

            | å¹³å° | æ–‡ä»¶ |
            |------|------|
            | macOS (Apple Silicon) | [EnsoAI-{VERSION}-arm64.dmg](https://github.com/${{ github.repository }}/releases/download/${{ steps.tag.outputs.name }}/EnsoAI-{VERSION}-arm64.dmg) |
            | macOS (Intel) | [EnsoAI-{VERSION}.dmg](https://github.com/${{ github.repository }}/releases/download/${{ steps.tag.outputs.name }}/EnsoAI-{VERSION}.dmg) |
            | Windows (x64 å®‰è£…ç‰ˆ) | [EnsoAI-Setup-{VERSION}.exe](https://github.com/${{ github.repository }}/releases/download/${{ steps.tag.outputs.name }}/EnsoAI-Setup-{VERSION}.exe) |

            > âš ï¸ **macOS ç”¨æˆ·æ³¨æ„**: ç”±äºåº”ç”¨æœªç­¾åï¼Œé¦–æ¬¡æ‰“å¼€å¯èƒ½æç¤º"å·²æŸå"ï¼Œè¯·åœ¨ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
            > ```bash
            > sudo xattr -dr com.apple.quarantine /Applications/EnsoAI.app
            > ```

            ---

            **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ steps.prev_tag.outputs.prev_tag }}...${{ steps.tag.outputs.name }}
            ```

            ç”Ÿæˆåï¼Œä½¿ç”¨ gh å‘½ä»¤æ›´æ–° release:
            ```bash
            gh release edit ${{ steps.tag.outputs.name }} --notes "ç”Ÿæˆçš„å†…å®¹"
            ```

            è¯·ç›´æ¥æ‰§è¡Œï¼Œä¸è¦è¯¢é—®ç¡®è®¤ã€‚
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
